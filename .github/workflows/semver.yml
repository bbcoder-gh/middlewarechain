# .github/workflows/validate-tag.yml
name: Validate Version Tag

on:
  push:
    tags:
      - 'v*'

jobs:
  validate-semver:
    name: Validate Semantic Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate semver format
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Validating tag: $TAG"
          
          # Check if tag follows semver (v1.2.3 or v1.2.3-beta.1)
          if ! [[ $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?(\+[a-zA-Z0-9\.]+)?$ ]]; then
            echo "❌ Tag '$TAG' doesn't follow semantic versioning"
            echo "Expected format: vMAJOR.MINOR.PATCH (e.g., v1.0.0, v2.1.3, v1.0.0-beta.1)"
            exit 1
          fi
          
          echo "✅ Tag follows semantic versioning"

      - name: Check version is greater than previous
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          LATEST=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v0.0.0")
          
          echo "Previous version: $LATEST"
          echo "New version: $TAG"
          
          # Remove 'v' prefix for comparison
          LATEST_VER=${LATEST#v}
          NEW_VER=${TAG#v}
          
          # Extract major.minor.patch
          IFS='.' read -r L_MAJ L_MIN L_PATCH <<< "${LATEST_VER%%-*}"
          IFS='.' read -r N_MAJ N_MIN N_PATCH <<< "${NEW_VER%%-*}"
          
          # Simple numeric comparison
          if [ "$N_MAJ" -gt "$L_MAJ" ]; then
            echo "✅ Major version bump"
          elif [ "$N_MAJ" -eq "$L_MAJ" ] && [ "$N_MIN" -gt "$L_MIN" ]; then
            echo "✅ Minor version bump"
          elif [ "$N_MAJ" -eq "$L_MAJ" ] && [ "$N_MIN" -eq "$L_MIN" ] && [ "$N_PATCH" -gt "$L_PATCH" ]; then
            echo "✅ Patch version bump"
          elif [[ "$TAG" == *"-"* ]]; then
            echo "✅ Pre-release version"
          else
            echo "❌ Version was not properly bumped!"
            echo "New version must be greater than $LATEST"
            exit 1
          fi

      - name: Run tests before release
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Test
        run: go test -v -race ./...
